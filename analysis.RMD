---
title: "H.pylori Rhesus Microbiome Analysis"
author: 
  - "Noah Siegel"
output:
    pdf_document:
        includes:
            in_header: file.tex
geometry: margin = 0.5in
fig_caption: yes
header-includes: 
  - \usepackage{placeins}
  - \usepackage{float}
  - \floatplacement{figure}{H}
---

# Data used in analysis

```{r include=FALSE}
# Set up global options for nice reports and keeping figures:
knitr::opts_chunk$set(fig.width=14, fig.height=8, fig.align="center",
                      warning=FALSE, message=FALSE)
```

## Library

```{r echo=TRUE}
suppressPackageStartupMessages({
  library(sjPlot)
  library(readxl)
  library(phyloseq)
  library(microbiome)
  library(DESeq2)
  library(qiime2R)
  library(tidyverse)
  library(tidyMicro)
  library(kableExtra)
  library(magrittr)
  library(ggpubr)
  library(microeco)
  library(tidytree)
  library(RColorBrewer)
  library(questionr)
  library(rmarkdown)
  library(stringr)
})
```

```{r echo=FALSE}
analysis_theme <-
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
    axis.text.x=element_text(size=25, face="bold"),
    axis.text.y=element_text(size=25, face="bold")
  )
```

```{r include=F}
# generate phyloseq object
metadata<-read.table(file.path(getwd(),"data", "noblank-sample-metadata.txt"), row.names=1, sep='\t', quote="", header=TRUE) # updated metadata for MLD manuscript-1
merge_meta <- metadata %>% unite(Site_status, Treatment, site, remove=F)
pub.metadatapath =normalizePath(path=tempdir(), winslash = "/", mustWork = NA) # fix windows path issue (will not work on unix OS)

# export cleaned metadata to temporary directory
write.table(merge_meta, file= paste(pub.metadatapath,"-metadata.tsv", sep=""), 
            quote=F, col.names = TRUE, sep='\t')
file= paste(pub.metadatapath,"-metadata.tsv", sep="")

physeq<-qza_to_phyloseq(
    features=file.path(getwd(), "data", "id_filtered-asv-table.qza"),
    tree=file.path(getwd(),"data", "rooted_tree.qza"),
    taxonomy=file.path(getwd(),"data", "filtered_tax_sklearn.qza"),
    metadata = file
    )
physeq <- subset_taxa(physeq, Genus != "NA")

```

```{r include=F}
metadata <-merge_meta
metadata <- metadata %>% rownames_to_column("SampleID")
uwunifrac<-read_qza(file.path(getwd(),"data", "unweighted_unifrac_pcoa_results.qza"))
phytree <- phy_tree(physeq)
```

```{r echo=F}
# Create ASV count table, taxa table, and metadata table for reference
table <- as.data.frame(otu_table(physeq))

write.csv(table,file.path('results', 'count_table.csv'))
```


```{r echo=F}
taxa <- as.data.frame(tax_table(physeq))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 

write.csv(table,file.path('results', 'taxa_table.csv'))
```

## ASV counts the taxa table are linked below:

### [ASV counts](https://github.com/nasiegel88/H.pylori-siegel_et_al_2022/blob/main/results/count_table.csv)\
### [Taxa table](https://github.com/nasiegel88/H.pylori-siegel_et_al_2022/blob/main/results/taxa_table.csv)

\newpage

```{r echo=F}
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
df <- subsetted
row.names(subsetted) <- subsetted[,1]

caption = 'H.pylori Metadata'
kbl(df,align = "l", digits = 3, booktabs = TRUE, longtable = FALSE, format = "latex",
    escape = TRUE, caption = caption) %>%
  kable_styling(
    latex_options = c("scale_down",
                      font_size = 16, pdf_font = "arial"))

```

\newpage

## Odds ratios of variables based on H. pylori status

```{r echo=F}
# Read age data as text
age_data <- read.table(file.path(getwd(),"data", "rdu_table.txt"), row.names=NULL, sep='\t', quote="", header=TRUE, colClasses = c(RDU. = "character"))

age_data <- na.omit(age_data) # remove NA rows

model <- age_data %>%
  rename(
    `Age (days)` = age_days_infants,
    `Weight (kg)` = infant_weight_kg,
    `IL-8 Lavage (pg)` = il_bal_pg.ml,
    `IL-8 Plasma (pg)` = il_plasma_pg.ml
  ) %>%
  select(HP_status, `Age (days)`, `Weight (kg)`, `IL-8 Lavage (pg)`, `IL-8 Plasma (pg)`)

reg <- glm(as.factor(HP_status) ~ `Weight (kg)`  + `Age (days)` + `IL-8 Lavage (pg)` + `IL-8 Plasma (pg)`, data=model, family=binomial)
p <- plot_model(reg,
             type="std2", group.terms = c(1, 2, 3, 4), vline.color="black", color=c("black")) + 
analysis_theme
ggsave(plot=p,
       filename="results/hp-oddsratios.png",
       width=16,
       height=8,
       dpi=300)
p + ggtitle('Odds ratios of variables based on H. pylori status')
```
 
```{r echo=F}
kable(odds.ratio(reg), digits = 3, booktabs = TRUE, format = "latex",) %>%
  kable_styling(latex_options = c("HOLD_position", "scale_down",font_size = 12, pdf_font = "arial"))
```

## Sequenced animal IL8 to H. pylori load correlations

```{r echo=F, fig.cap = "This plot only includes animals that had material sequenced and not all 25 animals from the study"}
no_duplicates <- metadata %>% filter(site=="BAL") # will remove duplicates
p <- ggscatter(no_duplicates,
          y = "IL8_Lavage", 
          x = "log10_cfu.gm",
          add = "reg.line",
          conf.int = TRUE, 
          cor.coef = TRUE,
          repel=T,
          cor.method = "pearson",
          cor.coeff.args = list(method = "pearson", label.x.npc = "left", label.y.npc = "bottom"),
          size=5,
          cor.coef.size = 10,
          xlab = "Gastric H. pylori load (log10CFU/g)",
          ylab = "Lavage IL8 (pg)") +
  ggtitle("H.pylori Il8 Pearson correlation") + 
analysis_theme
p <- ggpar(p , ylim = c(5, 20))
ggsave(plot=p,
       filename="results/BAL_IL8-corr.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "This plot only includes animals that had material sequenced and not all 25 animals from the study"}
no_duplicates <- metadata %>% filter(site=="BAL") # will remove duplicates
p <- ggscatter(no_duplicates,
          y = "IL8_Plasma",
          x = "log10_cfu.gm", 
          add = "reg.line",
          conf.int = TRUE, 
          cor.coef = TRUE,
          cor.method = "pearson",
          size=5,
          cor.coef.size = 10,
          ylab = "Plasma IL8 (pg)", 
          xlab = "Gastric H. pylori load (log10CFU/g)") +
  ggtitle("H.pylori plasma IL8 Pearson correlation") + 
analysis_theme
p <- ggpar(p)
ggsave(plot=p,
       filename="results/Serum_IL8_heparinized-corr.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, inlcude=F}
dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()
```

## Overlapping Taxa Between Sites and H. pylori Status

### Lavage overlapping taxa

```{r cache=F, echo=F}
# lavage
bp <- subset_samples(physeq, site=="BAL")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]

data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data1 <- data$merge_samples(use_group = "Treatment")

t1 <- trans_venn$new(data1, ratio = "numratio")

t1$col_names <- t1$col_names  %>% str_replace('.*', '')

# Create positions for labels
pos <- data.frame(x = c(3.5, 6.5), y = c(8.5, 8.5))

p <- t1$plot_venn(color_circle = c("green", "purple"),
             text_size = 9) + 
  annotate("text", x = pos$x, y = pos$y,
           label = c(
      expression(bolditalic('H. pylori (-)')), 
      expression(bolditalic('H. pylori (+)'))),
      size = 10)

ggsave(plot=p,
       filename="results/venn-diagram-lavage.png",
       width=16,
       height=8,
       dpi=300)
p +
ggtitle("Overlapping taxa between H. pylori (+) and (-) in lavage") + 
analysis_theme
```

### Buccal overlapping taxa

```{r echo=F}
# buccal
bp <- subset_samples(physeq, site=="Swab")

table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]

data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data1 <- data$merge_samples(use_group = "Treatment")

t1 <- trans_venn$new(data1, ratio = "numratio")

t1$col_names <- t1$col_names  %>% str_replace('.*', '')

# Create positions for labels
pos <- data.frame(x = c(3.5, 6.5), y = c(8.5, 8.5))

p <- t1$plot_venn(color_circle = c("orange", "blue"), 
             text_size = 9) + 
  annotate("text", x = pos$x, y = pos$y,
           label = c(
      expression(bolditalic('H. pylori (-)')), 
      expression(bolditalic('H. pylori (+)'))),
      size = 10)
ggsave(plot=p,
       filename="results/venn-diagram-buccal.png",
       width=16,
       height=8,
       dpi=300)
p +
ggtitle("Overlapping taxa between H. pylori (+) and (-) in buccal cavity") + 
analysis_theme
```

## Lefse analysis and differential abundance for both sites

```{r cache=F, echo=F}
ps <- subset_taxa(physeq, !is.na(Species) & !Phylum %in% c("", "uncharacterized"))
table <- as.data.frame(otu_table(ps))
taxa <- as.data.frame(tax_table(ps))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]

data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
  
t1 <- trans_diff$new(dataset = data, method = "lefse", group = "Site_status", alpha = 0.01, lefse_subgroup = NULL)

df <- t1$res_lefse[1:25, ]
title <- "Lefse taxa from bronchoalveolar lavage and oral swab"
write.csv(df, file.path('results', paste0(str_replace_all(title, ' ', '-'), '.csv')))

p <- t1$plot_lefse_bar(LDA_score = 2) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  guides(colour = "none") +
  scale_fill_manual(name="Status",
                    labels = c(expression(paste(italic("H. pylori"), "(-) Buccal")),
                               expression(paste(italic("H. pylori"), "(+) Buccal")),
                               expression(paste(italic("H. pylori"), "(-) Lavage")),
                               expression(paste(italic("H. pylori"), "(+) Lavage"))),
                    values=c("Orange", "Blue", "green", "purple")) + 
analysis_theme

ggsave(plot=p,
       filename="results/lefse-bal-swab.png",
       width=16,
       height=8,
       dpi=300)

p + ggtitle(title)
```

\newpage

### Relative abundance of differential taxa

```{r cache=F, echo=F}
p <- t1$plot_diff_abund(use_number = 1:10) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  guides(colour = "none") +
  scale_fill_manual(name="Status",
                    labels = c(expression(paste(italic("H. pylori"), "(-) Buccal")),
                               expression(paste(italic("H. pylori"), "(+) Buccal")),
                               expression(paste(italic("H. pylori"), "(-) Lavage")),
                               expression(paste(italic("H. pylori"), "(+) Lavage"))),
                    values=c("Orange", "Blue", "green", "purple")) + 
analysis_theme

ggsave(plot=p,
       filename="results/lefse-rel.abundance-bal-swab.png",
       width=16,
       height=8,
       dpi=300)

p + ggtitle("Lefse relative abundance from bronchoalveolar lavage and oral swab")
```

## Lefse and differential abundance for bronchoalveolar lavage

```{r cache=F, echo=F}
# lavage lefse
ps <- subset_taxa(physeq, !is.na(Species) & !Phylum %in% c("", "uncharacterized"))
bp <- subset_samples(ps, site=="BAL")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="BAL")
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data$sample_table <- subset(data$sample_table, site == "BAL")

t1 <- trans_diff$new(dataset = data, method = "lefse", group = "Site_status", alpha = 0.01, lefse_subgroup = NULL)

df <- t1$res_lefse[1:25, ]
title <- "Lefse Taxa from Bronchoalveolar Lavage"
write.csv(df, file.path('results', paste0(str_replace_all(title, ' ', '-'), '.csv')))

p <- t1$plot_lefse_bar(LDA_score = 2) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  guides(colour = "none") +
  scale_fill_manual(name="Status",
                    labels = c(
                      expression(paste(italic("H. pylori"), "(-) Lavage")),
                      expression(paste(italic("H. pylori"), "(+) Lavage"))),
                    values=c("green", "purple")) + 
analysis_theme

ggsave(plot=p,
       filename="results/lefse-bal.png",
       width=16,
       height=8,
       dpi=300)

p + ggtitle(title)
```


\newpage

### Relative abundance of differential taxa

```{r echo=F}
p <- t1$plot_diff_abund(use_number = 1:10) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  guides(colour = "none") +
  scale_fill_manual(name="Status",
                    labels = c(
                      expression(paste(italic("H. pylori"), "(-) Lavage")),
                      expression(paste(italic("H. pylori"), "(+) Lavage"))),
                    values=c("green", "purple"))  + 
analysis_theme

ggsave(plot=p,
       filename="results/lefse-rel.abundance-bal.png",
       width=16,
       height=8,
       dpi=300)

p + ggtitle("Lefse Relative Abundance from Bronchoalveolar Lavage") 
```

## Lefse and differential abundance for oral swabs

```{r cache=F, echo=F}
# buccal lefse
ps <- subset_taxa(physeq, !is.na(Species) & !Phylum %in% c("", "uncharacterized"))
bp <- subset_samples(ps, site=="Swab")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="Swab")
row.names(subsetted) <- subsetted[,1]

data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data$sample_table <- subset(data$sample_table, site == "Swab")

t1 <- trans_diff$new(dataset = data, method = "lefse", group = "Site_status", alpha = 0.01, lefse_subgroup = NULL)

df <- t1$res_lefse[1:13, ]
title <- "Lefse taxa from oral swabs"
write.csv(df, file.path('results', paste0(str_replace_all(title, ' ', '-'), '.csv')))

p <- t1$plot_lefse_bar(LDA_score = 2) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  guides(colour = "none") +
  scale_fill_manual(name="Status",
                    labels = c(expression(paste(italic("H. pylori"), "(-) Buccal")),
                               expression(paste(italic("H. pylori"), "(+) Buccal"))),
                    values=c("Orange", "Blue")) + 
analysis_theme

ggsave(plot=p,
       filename="results/lefse-swab.png",
       width=18,
       height=8,
       dpi=300)

p + ggtitle(title)
```

\newpage

### Relative abundance of differential taxa

```{r echo=F}
p <- t1$plot_diff_abund(use_number = 1:10) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  guides(colour = "none") +
  scale_fill_manual(name="Status",
                    labels = c(expression(paste(italic("H. pylori"), "(-) Buccal")),
                               expression(paste(italic("H. pylori"), "(+) Buccal"))),
                    values=c("Orange", "Blue")) + 
analysis_theme

ggsave(plot=p,
       filename="results/lefse-rel.abundance-swab.png",
       width=16,
       height=8,
       dpi=300)

p + ggtitle("Lefse relative abundance from oral swabs") 
```

## Beta diversity

### Unweighted unifrac PCoA plots

```{r include=F}
data=uwunifrac$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata)
uwunifrac$data$ProportionExplained
```

```{r echo=F}
# principle component breakdown
uwunifrac$data$ProportionExplained
PC1 = paste0("PC1 (",round(uwunifrac$data$ProportionExplained$PC1, digits = 2)*100, "%)")
PC2 = paste0("PC2 (",round(uwunifrac$data$ProportionExplained$PC2, digits = 2)*100, "%)")
```

```{r echo=F, figures-side, fig.show="hold"}
site = ggplot(data,aes(x=PC1, y=PC2, color=`site`)) +
geom_point(alpha=0.8, size=5) + 
scale_color_manual(name="Site", labels = c("Lavage", "Buccal"),
                   values=c("dark red", "dark blue")) + 
  labs(x = PC1, y = PC2) + 
analysis_theme

ggsave(plot=site,
       filename="results/site-unweighted_unifrac.png",
       width=16,
       height=8,
       dpi=300)

site + ggtitle("Unweighted unifrac PCoA")

treatment_site = ggplot(data,aes(x=PC1, y=PC2, color=interaction(Treatment,site))) +
geom_point(alpha=0.8, size=5) + 
  scale_color_manual(name="Status",
                    labels = c(
                      expression(paste(italic("H. pylori"), "(-) Buccal")),
                      expression(paste(italic("H. pylori"), "(+) Buccal")),
                      expression(paste(italic("H. pylori"), "(-) Lavage")),
                      expression(paste(italic("H. pylori"), "(+) Lavage"))),
                     values=c("green", "purple", "orange", "blue")) + 
  labs(x = PC1, y = PC2) + 
analysis_theme

ggsave(plot=treatment_site,
       filename="results/site_treatment-unweighted_unifrac.png",
       width=16,
       height=8,
       dpi=300)

treatment_site + ggtitle("Status Unweighted unifrac PCoA")
```

```{r echo=F}
data1 <- clone(dataset)
data1$cal_betadiv(unifrac = TRUE)
data1$tidy_dataset()

t1 <- trans_beta$new(dataset = data1, group = "Site_status", measure = "bray")
t1$cal_group_distance(within_group = T)
p <- t1$plot_group_distance(distance_pair_stat = T) +
  scale_color_manual(name="Site", 
                      labels = c(
                      expression(paste(italic("H. pylori"), "(-) Lavage")),
                      expression(paste(italic("H. pylori"), "(-) Buccal")),
                      expression(paste(italic("H. pylori"), "(+) Lavage")),
                      expression(paste(italic("H. pylori"), "(+) Buccal"))),
                     values=c("green", "orange", "purple", "blue")) +
        theme(
        text = element_text(size=30),
        plot.title = element_text(hjust = 0.5),
        axis.text.x=element_text(size=25, face="bold", angle = 90, vjust = 0.5, hjust=1),
        axis.text.y=element_text(size=25, face="bold")
      )

ggsave(plot=p,
       filename="results/bray-curtis-site_status.png",
       width=16,
       height=8,
       dpi=300)

p + ggtitle("Beta diversity")
```

### Bray-Curtis

```{r echo=F}
data1 <- clone(dataset)
data1$cal_betadiv(unifrac = TRUE)
data1$tidy_dataset()

t1 <- trans_beta$new(dataset = data1, group = "site", measure = "bray")
t1$cal_group_distance(within_group = T)
p <- t1$plot_group_distance(distance_pair_stat = T) +
            scale_color_manual(name="Site", values=c("dark red", "dark blue"),
                               labels=c('Lavage', 'Buccal')) +
  scale_x_discrete(labels=c('Lavage','Buccal'))  +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
     axis.text.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  )

ggsave(plot=p,
       filename="results/bray-curtis-site.png",
       width=16,
       height=8,
       dpi=300)

p + ggtitle("Beta diversity")
```

## Alpha Diversity

### Shannon index by site and H. pylori status

```{r echo=F}
data1 <- clone(dataset)
data1$cal_alphadiv(PD = TRUE)
data1$tidy_dataset()

t1 <- trans_alpha$new(dataset = data1, group = "Site_status")
df <- t1$alpha_data %>% 
  group_by(Measure) %>% 
  filter(Measure == "Shannon") %>%
  select(Site_status, Value)

p <- ggplot(df, aes_string(x = "Site_status", y = "Value", col="Site_status")) + 
            geom_boxplot(size = 1) +
            geom_point(size=4) +
  scale_color_manual(name="Status",
                    labels = c(
                      expression(paste(italic("H. pylori"), "(-) Buccal")),
                      expression(paste(italic("H. pylori"), "(+) Buccal")),
                      expression(paste(italic("H. pylori"), "(-) Lavage")),
                      expression(paste(italic("H. pylori"), "(+) Lavage"))),
                     values=c("green", "purple", "orange", "blue")) +
            labs(x = "", y = "Shannon") +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
     axis.text.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  )

ggsave(plot=p,
       filename="results/shannon-site-status.png",
       width=18,
       height=8,
       dpi=300)

p + ggtitle("Site & status") 
```

### Shannon index by site only

```{r echo=F}
data1 <- clone(dataset)
data1$cal_alphadiv(PD = TRUE)
data1$tidy_dataset()

t1 <- trans_alpha$new(dataset = data1, group = "site")
df <- t1$alpha_data %>% 
  group_by(Measure) %>% 
  filter(Measure == "Shannon") %>%
  select(site, Value)

p <- ggplot(df, aes_string(x = "site", y = "Value", col="site")) + 
            geom_boxplot(size = 1) +
            geom_point(size=4) +
            scale_color_manual(name="Site", values=c("dark red", "dark blue"),
                               labels=c('Lavage', 'Buccal'))+
            scale_x_discrete(
              labels=c('Lavage','Buccal')) +
            ggtitle("Status") +
            labs(x = "", y = "Shannon") + 
analysis_theme
ggsave(plot=p,
       filename="results/shannon.png",
       width=16,
       height=8,
       dpi=300)
p
```

\newpage

```{r echo=F}
data1$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = data1, group = "Site_status")
t1$cal_diff(method = "KW")

caption = 'All alpha diversity measurees'
kbl(t1$res_alpha_diff,align = "l", digits = 3, booktabs = TRUE, longtable = FALSE, format = "latex",
    escape = TRUE, caption = caption)  %>%
  kable_styling(
    latex_options = c("scale_down", "HOLD_position",font_size = 12, pdf_font = "arial"))
```

\newpage

## Helicobacter positive respiratory samples

### Helicobacter positive samples separated by site

```{r echo=F}
hp <-  subset_taxa(physeq, Genus == "Helicobacter")

p <- plot_bar(hp, "Treatment", "Abundance","Species", title="Helicobacter ASVs")  +
  theme_classic() +
  scale_x_discrete(labels = c(
    expression(italic('H. pylori (-)')), 
    expression(italic('H. pylori (+)'))))  + 
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size=30),
        axis.text.x = element_text(size = 20)) +
  facet_grid(cols = vars(site))
ggsave(plot=p,
       filename="results/helicobacter_abundance-treatment.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Helicobacter positive samples separated by animal

```{r echo=F}
hp <-  subset_taxa(physeq, Genus == "Helicobacter")
 hp@sam_data$RDU. <- factor( hp@sam_data$RDU.)

p <- plot_bar(hp, "RDU.", "Abundance","Species", title="Helicobacter ASVs")  +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size=30),
        axis.text.x = element_text(size = 15)) +
  facet_grid(cols = vars(site))
ggsave(plot=p,
       filename="results/helicobacter_abundance-mmu.png",
       width=16,
       height=8,
       dpi=300)
p
```

\newpage

## Taxa barplots

```{r echo=F, warning=FALSE, fig.cap = "Microbiota Composition at Phylum level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Phylum", ntaxa = 9)

t1$sample_table <- t1$sample_table %>%
  mutate(Treatment = str_replace_all(Treatment, '_', ' '))

p <- t1$plot_bar(others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic() +
  scale_fill_manual("Phylum",
                    values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size=30),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        legend.position = "bottom",
        legend.justification = c(0,1)) +
  scale_fill_discrete(name = "") +
  guides(fill = guide_legend(rnow = 3)) +
  ggtitle("Phylum")
ggsave(plot=p,
       filename="results/phylum-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t3 <- trans_abund$new(dataset = dataset, taxrank = "Phylum", groupmean="Site_status", ntaxa = 8)

t3$abund_data <- t3$abund_data %>%
  mutate(Sample = str_replace_all(Sample, '_', ' '))

p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Phylum",
                    values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(text = element_text(size=30),
        legend.position = "left",
         strip.text = element_text(size = 25)) 
  
ggsave(plot=p,
       filename="results/phylum-piechart.png",
       width=16,
       height=8,
       dpi=300,
       bg="white")
p
```

```{r echo=F}
# phyla pie chart
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)

caption = 'Phylum Average Relative Abundance'
kbl(kab,align = "l", digits = 4, booktabs = TRUE, longtable = FALSE, format = "latex",
    escape = TRUE, caption = caption) %>%
  kable_styling(
    latex_options = c("scale_down", "HOLD_position", font_size = 12, pdf_font = "arial"))
```

\newpage

```{r echo=F, warning=FALSE, fig.cap = "Microbiota Composition at Class level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Class", ntaxa = 9)

t1$sample_table <- t1$sample_table %>%
  mutate(Treatment = str_replace_all(Treatment, '_', ' '))

p <- t1$plot_bar(others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic() +
  scale_fill_manual("Class",
                    values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size=30),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "bottom",
        legend.justification = c(0,1)) +
  scale_fill_discrete(name = "") +
  guides(fill = guide_legend(rnow = 4, ncol = 3)) +
  ggtitle("Class")
ggsave(plot=p,
       filename="results/class-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Class", groupmean="Site_status", ntaxa = 8)

t3$abund_data <- t3$abund_data %>%
  mutate(Sample = str_replace_all(Sample, '_', ' '))

p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Class", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(text = element_text(size=30),
        legend.position = "left",
         strip.text = element_text(size = 25)) 
ggsave(plot=p,
       filename="results/class-piechart.png",
       width=16,
       height=8,
       dpi=300,
       bg="white")
p
```

```{r echo=F}
# class pie chart
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)

caption = 'Class Average Relative Abundance'
kbl(kab,align = "l", digits = 4, booktabs = TRUE, longtable = FALSE, format = "latex",
    escape = TRUE, caption = caption) %>%
  kable_styling(
    latex_options = c("scale_down", "HOLD_position", font_size = 12, pdf_font = "arial"))
```

\newpage

```{r echo=F, warning=FALSE, fig.cap = "Microbiota Composition at Order level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Order", ntaxa = 9)

t1$sample_table <- t1$sample_table %>%
  mutate(Treatment = str_replace_all(Treatment, '_', ' '))

p <- t1$plot_bar( others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic() +
  scale_fill_manual("Order",
                    values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount))  +
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size=30),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "bottom",
        legend.justification = c(0,1)) +
  scale_fill_discrete(name = "") +
  guides(fill = guide_legend(rnow = 3, ncol = 3)) +
  ggtitle("Order")
ggsave(plot=p,
       filename="results/order-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Order", groupmean="Site_status", ntaxa = 8)

t3$abund_data <- t3$abund_data %>%
  mutate(Sample = str_replace_all(Sample, '_', ' '))

p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Order",
                    values = colorRampPalette(brewer.pal(11,"Set3"))(colourCount)) +
  theme(text = element_text(size=30),
        legend.position = "left",
         strip.text = element_text(size = 25)) 

ggsave(plot=p,
       filename="results/order-piechart.png",
       width=16,
       height=8,
       dpi=300,
       bg="white")
p
```

```{r echo=F}
# order pie chart
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)

caption = 'Order Average Relative Abundance'
kbl(kab,align = "l", digits = 4, booktabs = TRUE, longtable = FALSE, format = "latex",
    escape = TRUE, caption = caption) %>%
  kable_styling(
    latex_options = c("scale_down", "HOLD_position", font_size = 12, pdf_font = "arial"))
```

\newpage

```{r echo=F, warning=FALSE, fig.cap = "Microbiota Composition at Family level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Family", ntaxa = 9)

t1$sample_table <- t1$sample_table %>%
  mutate(Treatment = str_replace_all(Treatment, '_', ' '))

p <- t1$plot_bar(others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic() +
  scale_fill_manual("Family",
                    values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size=30),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "bottom",
        legend.justification = c(0,1)) +
  scale_fill_discrete(name = "") +
  guides(fill = guide_legend(rnow = 3, ncol = 3)) +
  ggtitle("Family")
ggsave(plot=p,
       filename="results/family-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Family", groupmean="Site_status", ntaxa = 8)

t3$abund_data <- t3$abund_data %>%
  mutate(Sample = str_replace_all(Sample, '_', ' '))

p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Family", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(text = element_text(size=30),
        legend.position = "left",
         strip.text = element_text(size = 25))  
ggsave(plot=p,
       filename="results/family-piechart.png",
       width=16,
       height=8,
       dpi=300,
       bg="white")
p
```

```{r echo=F}
# family pie chart
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)

caption = 'Family Average Relative Abundance'
kbl(kab,align = "l", digits = 4, booktabs = TRUE, longtable = FALSE, format = "latex",
    escape = TRUE, caption = caption) %>%
  kable_styling(
    latex_options = c("scale_down", "HOLD_position", font_size = 12, pdf_font = "arial"))
```

\newpage

```{r echo=F, warning=FALSE, fig.cap = "Microbiota Composition at Genus level."}
# increase the number color to match phyla number
colourCount = 21
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Genus", ntaxa = 20)

t1$sample_table <- t1$sample_table %>%
  mutate(Treatment = str_replace_all(Treatment, '_', ' '))
p <- t1$plot_bar(others_color = "grey70",
                 facet = c("site","Treatment"), 
                 xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic() +
  scale_fill_manual("Genus",
                    values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5), text = element_text(size=30),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "bottom",
        legend.justification = c(0,1)) +
  scale_fill_discrete(name = "") +
  guides(fill = guide_legend(rnow = 12, ncol = 2)) +
  ggtitle("Genus")
ggsave(plot=p,
       filename="results/genus-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Genus", groupmean="Site_status", ntaxa = 8) 

t3$abund_data <- t3$abund_data %>%
  mutate(Sample = str_replace_all(Sample, '_', ' '))

p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Genus", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount))  +
  theme(text = element_text(size=30),
        legend.position = "left",
         strip.text = element_text(size = 25)) 
ggsave(plot=p,
       filename="results/genus-piechart.png",
       width=16,
       height=8,
       dpi=300,
       bg="white")
p
```

```{r echo=F}
# genera pie chart
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)

caption = 'Genus Average Relative Abundance'
kbl(kab,align = "l", digits = 4, booktabs = TRUE, longtable = FALSE, format = "latex",
    escape = TRUE, caption = caption) %>%
  kable_styling(
    latex_options = c("scale_down", "HOLD_position", font_size = 12, pdf_font = "arial"))
```

\newpage

## Genera correlation with Il8 concentration (Serum and BAL)
####
```{r echo=F, cache=F, fig.cap = "IL8 and lavage genus abundance Spearman correlations separated by H. pylori status"}
# lavage
bp <- subset_samples(physeq, site=="BAL")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                log10_cfu.gm,
                sex,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="BAL")
row.names(subsetted) <- subsetted[,1]

dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()

t2 <- trans_diff$new(dataset = dataset, method = "rf", group = "Treatment", rf_taxa_level = "Genus")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])

# calculate correlation
t1$cal_cor(use_data = "other",
           p_adjust_method = "fdr",
           cor_method="spearman",
           by_group="Treatment",
          
           other_taxa = t2$res_rf$Taxa[1:20])
p <- t1$plot_corr()  + 
  scale_x_discrete(labels=c(
    'IL-8 Lavage', 
    'IL-8 Plasma', 
    'IL-8 Lavage', 
    'IL-8 Plasma')
  ) +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
    axis.text.x=element_text(size=25, face="bold", angle = 45, vjust = 1, hjust=1),
    axis.title.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  ) +
   geom_text(aes(label = Significance), color="white", size=10)

ggsave(plot=p + ggtitle('lavage'),
       filename="results/lavage-abundance_sep-hp_il8-spearman.png",
       width=16,
       height=11,
       dpi=300)

p + ggtitle(expression(atop("Lavage Genus Abundance",
                           atop(italic("Grouped by H. pylori status"), ""))))
```

```{r echo=F, fig.cap = "IL8 and lavage genus abundance Spearman correlations independent of H. pylori status"}
# calculate correlations for different groups using parameter by_group
t1$cal_cor(by_group = "site", use_data = "other", p_adjust_method = "fdr", other_taxa = t2$res_rf$Taxa[1:20])

p <- t1$plot_corr() + 
  scale_x_discrete(labels=c(
    'IL-8 Lavage', 
    'IL-8 Plasma', 
    'IL-8 Lavage', 
    'IL-8 Plasma')
  ) +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
    axis.text.x=element_text(size=30, face="bold", angle = 45, vjust = 1, hjust=1),
    axis.title.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  ) +
   geom_text(aes(label = Significance), color="white", size=20)

ggsave(plot=p + ggtitle('lavage'),
       filename="results/lavage-abundance_ind-hp_il8-spearman.png",
       width=16,
       height=11,
       dpi=300)

p + ggtitle(expression(atop("Lavage Genus Abundance", atop(italic("Independent of H. pylori status"), ""))))
```

```{r echo=F}
# table of correlation values
df <- t1$res_cor[1:20, ]

write.csv(table,file.path('results', 'Lavage-IL8-spearman.csv'))
```

\newpage

```{r echo=F, fig.cap = "IL8 and lavage alpha diversity Spearman correlations inpendent of H. pylori status."}
dataset$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = dataset, group = "Site_status")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])

t1$cal_cor(add_abund_table = dataset$alpha_diversity)
p <- t1$plot_corr()  + 
  scale_x_discrete(labels=c(
    'IL-8 Lavage', 
    'IL-8 Plasma', 
    'IL-8 Lavage', 
    'IL-8 Plasma')
  ) +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
    axis.text.x=element_text(size=30, face="bold", angle = 45, vjust = 1, hjust=1),
    axis.title.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  ) +
   geom_text(aes(label = Significance), color="white", size=20)


ggsave(plot=p + ggtitle('lavage'),
       filename="results/lavage-alpha_il8-spearman.png",
       width=16,
       height=11,
       dpi=300)

p + ggtitle(expression(atop("Lavage Alpha Diversity", atop(italic("Independent of H. pylori status"), ""))))
```

```{r echo=F}
# table of correlation values
df <- t1$res_cor[1:20, ]

write.csv(table,file.path('results', 'Lavage-Alpha-Diversity.csv'))
```

\newpage

```{r echo=F, cache=F, fig.cap = "IL8 and Buccal genus abundance Spearman correlations separated by H. pylori status"}
# buccal
bp <- subset_samples(physeq, site=="Swab")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                log10_cfu.gm,
                sex,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="Swab")
row.names(subsetted) <- subsetted[,1]

dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()

t2 <- trans_diff$new(dataset = dataset, method = "rf", group = "Treatment", rf_taxa_level = "Genus")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])

# calculate correlation
p <- t1$cal_cor(use_data = "other",
           p_adjust_method = "fdr",
           cor_method="spearman",
           by_group="Treatment",
           other_taxa = t2$res_rf$Taxa[1:20])
p <- t1$plot_corr()  + 
  scale_x_discrete(labels=c(
    'IL-8 Lavage', 
    'IL-8 Plasma', 
    'IL-8 Lavage', 
    'IL-8 Plasma')
  ) +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
    axis.text.x=element_text(size=30, face="bold", angle = 45, vjust = 1, hjust=1),
    axis.title.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  ) +
   geom_text(aes(label = Significance), color="white", size=20)

ggsave(plot=p + ggtitle('Buccal'),
       filename="results/buccal-abundance_sep-hp_il8-spearman.png",
       width=16,
       height=11,
       dpi=300)

p + ggtitle(expression(atop("Buccal Cavity Genus Abundance", atop(italic("Grouped by H. pylori status"), ""))))
```

\newpage

```{r echo=F, fig.cap = "IL8 and  Buccal genus abundance Spearman correlations independent of H. pylori status"}
t1$cal_cor(by_group = "site", use_data = "other", p_adjust_method = "fdr", other_taxa = t2$res_rf$Taxa[1:20])

p <- t1$plot_corr()  + 
  scale_x_discrete(labels=c(
    'IL-8 Lavage', 
    'IL-8 Plasma', 
    'IL-8 Lavage', 
    'IL-8 Plasma')
  ) +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
    axis.text.x=element_text(size=30, face="bold", angle = 45, vjust = 1, hjust=1),
    axis.title.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  ) +
   geom_text(aes(label = Significance), color="white", size=20)

ggsave(plot=p + ggtitle('Buccal'),
       filename="results/buccal-abundance_ind-hp_il8-spearman.png",
       width=16,
       height=11,
       dpi=300)

p + ggtitle(expression(atop("Buccal Cavity Genus Abundance", atop(italic("Independent of H. pylori status"), ""))))
```

```{r echo=F}
# table of correlation values
df <- t1$res_cor[1:40, ]

write.csv(table,file.path('results', 'Buccal-Cavity-Genus-Abundance.csv'))
```

\newpage

```{r echo=F, fig.cap = "IL8 and Buccal alpha diversity Spearman correlations independent of H. pylori status"}
dataset$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = dataset, group = "Site_status")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])

t1$cal_cor(add_abund_table = dataset$alpha_diversity)
p <- t1$plot_corr() + 
  scale_x_discrete(labels=c(
    'IL-8 Lavage', 
    'IL-8 Plasma')
  ) +
  theme_classic() +
  theme(
    text = element_text(size=30),
    plot.title = element_text(hjust = 0.5),
    axis.text.x=element_text(size=30, face="bold", angle = 45, vjust = 1, hjust=1),
    axis.title.x=element_blank(),
    axis.text.y=element_text(size=25, face="bold")
  ) +
   geom_text(aes(label = Significance), color="white", size=20)

ggsave(plot=p + ggtitle('Buccal'),
       filename="results/buccal-alpha_il8-spearman.png",
       width=16,
       height=11,
       dpi=300)

p + ggtitle(expression(atop("Buccal Cavity Alpha Diversity", atop(italic("Independent of H. pylori status"), ""))))
```

```{r echo=F}
# table of correlation values
df <- t1$res_cor[1:20, ]

write.csv(table,file.path('results', 'Buccal-Cavity-Alpha-Diversity.csv'))
```

\newpage

## Record session information

```{r session_info, echo=F}
sessionInfo()
```
