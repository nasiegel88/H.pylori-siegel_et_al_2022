---
title: "H.pylori Rhesus Microbiome Analysis"
author: 
  - "Noah Siegel"
date:  "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs",
  output_format = "all")})
output:
  github_document:
    html_preview: true
---

## Data used in analysis

```{r include=F}
source("R/packages.R")
source("R/seasons.R")
# Set up global options for nice reports and keeping figures:
knitr::opts_chunk$set(fig.width=14, fig.height=8, fig.align="center",
                      warning=FALSE, message=FALSE)
# install dependencies
```

```{r include=F}
# generate phyloseq object
metadata<-read.table(file.path(getwd(),"data", "noblank-sample-metadata.txt"), row.names=1, sep='\t', quote="", header=TRUE) # updated metadata for MLD manuscript-1
merge_meta <- metadata %>% unite(Site_status, Treatment, site, remove=F)
pub.metadatapath =normalizePath(path=tempdir(), winslash = "/", mustWork = NA) # fix window path issue

# export cleaned metadata to temporary directory
write.table(merge_meta, file= paste(pub.metadatapath,"-metadata.tsv", sep=""), 
            quote=F, col.names = TRUE, sep='\t')
file= paste(pub.metadatapath,"-metadata.tsv", sep="")

physeq<-qza_to_phyloseq(
    features=file.path(getwd(), "data", "id_filtered-asv-table.qza"),
    tree=file.path(getwd(),"data", "rooted_tree.qza"),
    taxonomy=file.path(getwd(),"data", "filtered_tax_sklearn.qza"),
    metadata = file
    )
physeq <- subset_taxa(physeq, Genus != "NA")

```

```{r include=F}
metadata <-merge_meta
metadata <- metadata %>% rownames_to_column("SampleID")
uwunifrac<-read_qza(file.path(getwd(),"data", "unweighted_unifrac_pcoa_results.qza"))
phytree <- phy_tree(physeq)
```

```{r echo=F}
# original physeq
table <- as.data.frame(otu_table(physeq))

kbl(table, booktabs = T, digits = 3, caption = "ASV Count Table") %>% kable_styling(position = "left") %>%
  add_header_above(c("ASV Count Table" = 27), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "200%", height = "600px")

taxa <- as.data.frame(tax_table(physeq))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
kbl(taxa, booktabs = T, digits = 3, caption = "ASV Taxa Table") %>% kable_styling(position = "left") %>%
  add_header_above(c("ASV Taxa Table" = 8), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "200%", height = "600px")

subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]
kable(subsetted, align = 'c', digits = 3, caption = "H.pylori Metadata") %>% kable_styling(position = "center") %>%
  add_header_above(c("H.pylori Metadata" = 9), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
subsetted <- subsetted[1:(length(subsetted)-1)]
```

## Sequenced animal IL8 to H. pylori load correlations

```{r echo=F, fig.cap = "This plot only includes animals that had material sequenced and not all 25 animals from the study"}
no_duplicates <- metadata %>% filter(site=="BAL") # will remove duplicates
p <- ggscatter(no_duplicates,
          y = "IL8_Lavage", 
          x = "log10_cfu.gm",
          add = "reg.line",
          conf.int = TRUE, 
          cor.coef = TRUE,
          repel=T,
          cor.method = "pearson",
          cor.coeff.args = list(method = "pearson", label.x.npc = "left", label.y.npc = "bottom"),
          size=5,
          cor.coef.size = 10,
          xlab = "Gastric H. pylori load (log10CFU/g)",
          ylab = "Lavage IL8 (pg)") +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("H.pylori Il8 Pearson correlation")
p <- ggpar(p , ylim = c(5, 20))
ggsave(plot=p,
       filename="results/BAL_IL8-corr.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "This plot only includes animals that had material sequenced and not all 25 animals from the study"}
no_duplicates <- metadata %>% filter(site=="BAL") # will remove duplicates
p <- ggscatter(no_duplicates,
          y = "IL8_Plasma",
          x = "log10_cfu.gm", 
          add = "reg.line",
          conf.int = TRUE, 
          cor.coef = TRUE,
          cor.method = "pearson",
          size=5,
          cor.coef.size = 10,
          ylab = "Plasma IL8 (pg)", 
          xlab = "Gastric H. pylori load (log10CFU/g)") +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("H.pylori plasma IL8 Pearson correlation")
p <- ggpar(p)
ggsave(plot=p,
       filename="results/Serum_IL8_heparinized-corr.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, inlcude=F}
# original physeq
dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(dataset)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()
```

## Overlapping Taxa Between Sites and H. pylori Status

### Lavage overlapping taxa

```{r cache=F, echo=F}
#BAL
bp <- subset_samples(physeq, site=="BAL")

table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(data)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data1 <- data$merge_samples(use_group = "Treatment")
t1 <- trans_venn$new(data1, ratio = "numratio")
p <- t1$plot_venn(color_circle = c("green", "purple"),
             text_name_size = 6,
             text_size = 9) +
  ggtitle("Overlapping taxa between H. pylori (+) and (-) in lavage")
ggsave(plot=p,
       filename="results/venn-diagram-lavage.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Buccal overlapping taxa

```{r}
#swab
bp <- subset_samples(physeq, site=="Swab")

table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(data)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data1 <- data$merge_samples(use_group = "Treatment")
t1 <- trans_venn$new(data1, ratio = "numratio")
p <- t1$plot_venn(color_circle = c("orange", "blue"), 
             text_name_size = 6,
             text_size = 9) +
  ggtitle("Overlapping taxa between H. pylori (+) and (-) in buccal cavity")
ggsave(plot=p,
       filename="results/venn-diagram-buccal.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Lefse analysis and differential abundance for both sites

```{r cache=F, echo=F}
ps <- subset_taxa(physeq, !is.na(Species) & !Phylum %in% c("", "uncharacterized"))

table <- as.data.frame(otu_table(ps))
taxa <- as.data.frame(tax_table(ps))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(data)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
  
t1 <- trans_diff$new(dataset = data, method = "lefse", group = "Site_status", alpha = 0.01, lefse_subgroup = NULL)
p <- t1$plot_lefse_bar(LDA_score = 2) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  scale_fill_manual(name="Status",labels = c("H. pylori (-) Swab", "H. pylori (+) Swab", "H. pylori (-) Lavage", "H. pylori (+) Lavage"), values=c("Orange", "Blue", "green", "purple"))  +
  ggtitle("Lefse taxa from bronchoalveolar lavage and oral swab")
ggsave(plot=p,
       filename="results/lefse-bal-swab.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Lefse table

```{r echo=F}
df <- t1$res_lefse[1:5, ]
kable(df, align = 'c', digits = 4, caption = "Lefse taxa from bronchoalveolar lavage and oral swab") %>% kable_styling(position = "center") %>%
  add_header_above(c("Lefse taxa from bronchoalveolar lavage and oral swab" = 5), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

### Relative abundance of differential taxa

```{r cache=F, echo=F}
p <- t1$plot_diff_abund(use_number = 1:10) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  scale_fill_manual(name="Status",labels = c("H. pylori (-) Swab", "H. pylori (+) Swab", "H. pylori (-) Lavage", "H. pylori (+) Lavage"), values=c("Orange", "Blue", "green", "purple")) +
  ggtitle("Lefse relative abundance from bronchoalveolar lavage and oral swab")
ggsave(plot=p,
       filename="results/lefse-rel.abundance-bal-swab.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Lefse and differential abundance for bronchoalveolar lavage

```{r cache=F, echo=F}
# bal physeq
ps <- subset_taxa(physeq, !is.na(Species) & !Phylum %in% c("", "uncharacterized"))
bp <- subset_samples(ps, site=="BAL")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="BAL")
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(data)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data$sample_table <- subset(data$sample_table, site == "BAL")


t1 <- trans_diff$new(dataset = data, method = "lefse", group = "Site_status", alpha = 0.01, lefse_subgroup = NULL)
p <- t1$plot_lefse_bar(LDA_score = 2) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  scale_fill_manual(name="Status",labels = c("H. pylori (-) Lavage", "H. pylori (+) Lavage"), values=c("green", "purple")) +
  ggtitle("Lefse Taxa from Bronchoalveolar Lavage")
ggsave(plot=p,
       filename="results/lefse-bal.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Lefse table

```{r echo=F}
df <- t1$res_lefse[1:25, ]
kable(df, align = 'c', digits = 4, caption = "Lefse Taxa from Bronchoalveolar Lavage") %>% kable_styling(position = "center") %>%
  add_header_above(c("Lefse Taxa from Bronchoalveolar Lavage" = 5), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

### Relative abundance of differential taxa

```{r echo=F}
p <- t1$plot_diff_abund(use_number = 1:10) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  scale_fill_manual(name="Status",labels = c("H. pylori (-) Lavage", "H. pylori (+) Lavage"), values=c("green", "purple")) +
  ggtitle("Lefse Relative Abundance from Bronchoalveolar Lavage")
ggsave(plot=p,
       filename="results/lefse-rel.abundance-bal.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Lefse and differential abundance for oral swabs

```{r cache=F, echo=F}
# swab physeq
ps <- subset_taxa(physeq, !is.na(Species) & !Phylum %in% c("", "uncharacterized"))
bp <- subset_samples(ps, site=="Swab")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="Swab")
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(data)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data$sample_table <- subset(data$sample_table, site == "Swab")

t1 <- trans_diff$new(dataset = data, method = "lefse", group = "Site_status", alpha = 0.01, lefse_subgroup = NULL)
p <- t1$plot_lefse_bar(LDA_score = 2) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  scale_fill_manual(name="Status",labels = c("H. pylori (-) Swab", "H. pylori (+) Swab"), values=c("Orange", "Blue")) +
  ggtitle("Lefse taxa from oral swabs")
ggsave(plot=p,
       filename="results/lefse-swab.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Lefse table

```{r echo=F}
df <- t1$res_lefse[1:13, ]
kable(df, align = 'c', digits = 4, caption = "Lefse Taxa from oral swabs") %>% kable_styling(position = "center") %>%
  add_header_above(c("Lefse taxa from oral swabs" = 5), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

### Relative abundance of differential taxa

```{r echo=F}
p <- t1$plot_diff_abund(use_number = 1:10) +
  scale_colour_manual(values=c("black", "black", "black", "black")) +
  scale_fill_manual(name="Status",labels = c("H. pylori (-) Swab", "H. pylori (+) Swab"), values=c("Orange", "Blue")) +
  ggtitle("Lefse relative abundance from oral swabs")
ggsave(plot=p,
       filename="results/lefse-rel.abundance-swab.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Beta diversity

### Unweighted unifrac PCoA plots

```{r include=F}
data=uwunifrac$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata)
```

```{r echo=F, figures-side, fig.show="hold"}
site = ggplot(data,aes(x=PC1, y=PC2, color=`site`)) +
geom_point(alpha=0.8, size=4) + 
theme_q2r() +
scale_color_manual(name="Site", labels = c("Lavage", "Buccal"), values=c("dark red", "dark blue")) + 
theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Unweighted unifrac PCoA")
ggsave(plot=site,
       filename="results/site-unweighted_unifrac.png",
       width=16,
       height=8,
       dpi=300)
site

treatment_site = ggplot(data,aes(x=PC1, y=PC2, color=interaction(Treatment,site))) +
geom_point(alpha=0.8, size=4) + 
theme_q2r() +
scale_color_manual(name="Status",labels = c("H. pylori (-) Lavage", "H. pylori (+) Lavage", "H. pylori (-) Buccal", "H. pylori (+) Buccal"), values=c("green", "purple", "orange", "blue")) + 
theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Status Unweighted unifrac PCoA")
ggsave(plot=treatment_site,
       filename="results/site_treatment-unweighted_unifrac.png",
       width=16,
       height=8,
       dpi=300)
treatment_site
```

```{r echo=F}
data1 <- clone(dataset)
data1$cal_betadiv(unifrac = TRUE)
data1$tidy_dataset()

t1 <- trans_beta$new(dataset = data1, group = "Site_status", measure = "bray", ordination = "PCoA")
t1$cal_group_distance(within_group = T)
p <- t1$plot_group_distance(distance_pair_stat = T) +
  scale_color_manual(name="Site", values=c("green", "orange", "purple", "blue")) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Beta diversity")
ggsave(plot=p,
       filename="results/bray-curtis-site_status.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Bray-Curtis

```{r echo=F}
data1 <- clone(dataset)
data1$cal_betadiv(unifrac = TRUE)
data1$tidy_dataset()

t1 <- trans_beta$new(dataset = data1, group = "site", measure = "bray", ordination = "PCoA")
t1$cal_group_distance(within_group = T)
p <- t1$plot_group_distance(distance_pair_stat = T) +
  scale_color_manual(name="Status", values=c("dark red", "dark blue")) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Beta diversity")
ggsave(plot=p,
       filename="results/bray-curtis-site.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Alpha Diversity

### Shannon index by site and H. pylori status

```{r echo=F}
data1 <- clone(dataset)
data1$cal_alphadiv(PD = TRUE)
data1$tidy_dataset()

t1 <- trans_alpha$new(dataset = data1, group = "Site_status")
p <- t1$plot_alpha(pair_compare = F, measure = "Shannon") +
  scale_color_manual(name="Site", values=c("green", "orange", "purple", "blue")) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Site & status")
ggsave(plot=p,
       filename="results/shannon-site-status.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Shannon index by site only

```{r echo=F}
data1 <- clone(dataset)
data1$cal_alphadiv(PD = TRUE)
data1$tidy_dataset()

t1 <- trans_alpha$new(dataset = data1, group = "site")
p <- t1$plot_alpha(pair_compare = T, measure = "Shannon") +
  scale_color_manual(name="Status", values=c("dark red", "dark blue")) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Status")
ggsave(plot=p,
       filename="results/shannon-status.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Additional alpha diversity measures

```{r echo=F}
data1$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = data1, group = "Site_status")
t1$cal_diff(method = "KW")
kable(t1$res_alpha_diff, align = 'c', digits = 3, caption = "All alpha diversity measurees") %>% kable_styling(position = "center") %>%
  add_header_above(c("Apha Diversity Assessement" = 5), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%",height = "600px")
```

## Helicobacter positive respiratory samples

### Helicobacter positive samples separated by site

```{r echo=F, out.extra='style="float:left"'}
hp <-  subset_taxa(physeq, Genus == "Helicobacter")

p <- plot_bar(hp, "Treatment", "Abundance","Species", title="Helicobacter ASVs")  +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(cols = vars(site))
ggsave(plot=p,
       filename="results/helicobacter_abundance-treatment.png",
       width=16,
       height=8,
       dpi=300)
p
```

### Helicobacter positive samples separated by animal

```{r echo=F, out.extra='style="float:left"'}
hp <-  subset_taxa(physeq, Genus == "Helicobacter")
 hp@sam_data$MMU <- factor( hp@sam_data$MMU)

p <- plot_bar(hp, "MMU", "Abundance","Species", title="Helicobacter ASVs")  +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(cols = vars(site))
ggsave(plot=p,
       filename="results/helicobacter_abundance-mmu.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Taxa barplots

```{r echo=F, fig.cap = "Microbiota Composition at Phylum level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Phylum", ntaxa = 9)
p <- t1$plot_bar(use_colors=spring, others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  scale_fill_manual("Phylum", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Phylum")
ggsave(plot=p,
       filename="results/phylum-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t3 <- trans_abund$new(dataset = dataset, taxrank = "Phylum", groupmean="Site_status", ntaxa = 8)
p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Phylum", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount))
ggsave(plot=p,
       filename="results/phylum-piechart.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)
kable(kab, align = 'c', digits = 4, caption = "Average Relative Abundance") %>% kable_styling(position = "center") %>%
  add_header_above(c("Phylum" = 3), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r echo=F, fig.cap = "Microbiota Composition at Class level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Class", ntaxa = 9)
p <- t1$plot_bar(use_colors=spring, others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  scale_fill_manual("Class", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Class")
ggsave(plot=p,
       filename="results/class-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Class", groupmean="Site_status", ntaxa = 8)
p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Class", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount))
ggsave(plot=p,
       filename="results/class-piechart.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)
kable(kab, align = 'c', digits = 4, caption = "Average Relative Abundance") %>% kable_styling(position = "center") %>%
  add_header_above(c("Class" = 3), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r echo=F, fig.cap = "Microbiota Composition at Order level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Order", ntaxa = 9)
p <- t1$plot_bar(use_colors=spring, others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  scale_fill_manual("Order", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Order")
ggsave(plot=p,
       filename="results/order-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Order", groupmean="Site_status", ntaxa = 8)
p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Order", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount))
ggsave(plot=p,
       filename="results/order-piechart.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)
kable(kab, align = 'c', digits = 4, caption = "Average Relative Abundance") %>% kable_styling(position = "center") %>%
  add_header_above(c("Order" = 3), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r echo=F, fig.cap = "Microbiota Composition at Family level."}
# increase the number color to match phyla number
colourCount = 10
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Family", ntaxa = 9)
p <- t1$plot_bar(use_colors=spring, others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  scale_fill_manual("Family", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Family")
ggsave(plot=p,
       filename="results/family-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Family", groupmean="Site_status", ntaxa = 8)
p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Family", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount))
ggsave(plot=p,
       filename="results/family-piechart.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)
kable(kab, align = 'c', digits = 4, caption = "Average Relative Abundance") %>% kable_styling(position = "center") %>%
  add_header_above(c("Family" = 3), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r echo=F, fig.cap = "Microbiota Composition at Genus level."}
# increase the number color to match phyla number
colourCount = 21
getPalette <- colorRampPalette(brewer.pal(8, "Paired"))

t1 <- trans_abund$new(dataset = dataset, taxrank = "Genus", ntaxa = 20)
p <- t1$plot_bar(use_colors=spring,
                 others_color = "grey70",
                 facet = c("site","Treatment"), 
                 xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  scale_fill_manual("Order", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Genus")
ggsave(plot=p,
       filename="results/genus-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p

t3 <- trans_abund$new(dataset = dataset, taxrank = "Genus", groupmean="Site_status", ntaxa = 8)
p <- t3$plot_pie(facet_nrow = 3, "grey50") + 
  scale_fill_manual("Genus", values = colorRampPalette(brewer.pal(11, "Set3"))(colourCount))
ggsave(plot=p,
       filename="results/genus-piechart.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t3$abund_data
df$Taxonomy <- factor(df$Taxonomy)
df$Sample <- factor(unique(df$Sample))
taxa <- (unique(df$Taxonomy))
table_percent <- df %>%
            mutate(Taxonomy = factor(Taxonomy, 
                levels = taxa[length(taxa):1]),
              cumulative = cumsum(Abundance),
                midpoint = cumulative - Abundance / 2,
                `Average Percent Abundance` = paste0(round((Abundance) * 1, 1), "%"))
tab <- table_percent[order(table_percent$Abundance, decreasing = T),][1:32,] 
tab$Taxonomy <- as.character(tab$Taxonomy)
kab <- tab %>% arrange(Taxonomy) %>% select(Taxonomy, Sample, `Average Percent Abundance`)
kable(kab, align = 'c', digits = 4, caption = "Average Relative Abundance") %>% kable_styling(position = "center") %>%
  add_header_above(c("Genus" = 3), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

## Genera correlation with Il8 concentration (Serum and BAL)

```{r echo=F, cache=F, fig.cap = "IL8 and lavage genus abundance Spearman correlations separated by H. pylori status"}
#BAL
bp <- subset_samples(physeq, site=="BAL")

table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                log10_cfu.gm,
                sex,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="BAL")
row.names(subsetted) <- subsetted[,1]
# original physeq
dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(dataset)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()

# first create trans_diff object
t2 <- trans_diff$new(dataset = dataset, method = "rf", group = "Treatment", rf_taxa_level = "Genus")
# then create trans_env object
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# calculate correlation
t1$cal_cor(use_data = "other",
           p_adjust_method = "fdr",
           cor_method="spearman",
           by_group="Treatment",
           other_taxa = t2$res_rf$Taxa[1:20])
p <- t1$plot_corr()+
  theme_classic(base_size = 20) +
  theme(plot.title = element_text(hjust = 0.5)) +
   ggtitle(expression(atop("Lavage Genus Abundance", atop(italic("Grouped by H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/lavage-abundance_sep-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "IL8 and lavage genus abundance Spearman correlations independent of H. pylori status"}
# calculate correlations for different groups using parameter by_group
t1$cal_cor(by_group = "site", use_data = "other", p_adjust_method = "fdr", other_taxa = t2$res_rf$Taxa[1:20])
# return t1$res_cor
p <- t1$plot_corr()+
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle(expression(atop("Lavage Genus Abundance", atop(italic("Independent of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/lavage-abundance_ind-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t1$res_cor[1:20, ]
kable(df, align = 'c', digits = 4, caption = "Independent of H. pylori status") %>% kable_styling(position = "center") %>%
  add_header_above(c("Lavage IL8 spearman" = 8), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r echo=F, fig.cap = "IL8 and lavage alpha diversity Spearman correlations inpendent of H. pylori status."}
dataset$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = dataset, group = "Site_status")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# use add_abund_table parameter to add the extra data table
t1$cal_cor(add_abund_table = dataset$alpha_diversity)
p <- t1$plot_corr() +
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle(expression(atop("Lavage Alpha Diversity", atop(italic("Independent of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/lavage-alpha_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t1$res_cor[1:20, ]
kable(df, align = 'c', digits = 4, caption = "Independent of H. pylori status") %>% kable_styling(position = "center") %>%
  add_header_above(c("Lavage Alpha Diversity" = 8), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r echo=F, cache=F, fig.cap = "IL8 and Buccal genus abundance Spearman correlations separated by H. pylori status"}
#Swab
bp <- subset_samples(physeq, site=="Swab")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                log10_cfu.gm,
                sex,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="Swab")
row.names(subsetted) <- subsetted[,1]
# original physeq
dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(dataset)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()

# first create trans_diff object
t2 <- trans_diff$new(dataset = dataset, method = "rf", group = "Treatment", rf_taxa_level = "Genus")
# then create trans_env object
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# calculate correlation
p <- t1$cal_cor(use_data = "other",
           p_adjust_method = "fdr",
           cor_method="spearman",
           by_group="Treatment",
           other_taxa = t2$res_rf$Taxa[1:20])
p <- t1$plot_corr()+
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle(expression(atop("Buccal Cavity Genus Abundance", atop(italic("Grouped by H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/buccal-abundance_sep-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "IL8 and  Buccal genus abundance Spearman correlations independent of H. pylori status"}
# calculate correlations for different groups using parameter by_group
t1$cal_cor(by_group = "site", use_data = "other", p_adjust_method = "fdr", other_taxa = t2$res_rf$Taxa[1:20])
# return t1$res_cor
p <- t1$plot_corr()+
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle(expression(atop("Buccal Cavity Genus Abundance", atop(italic("Independent of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/buccal-abundance_ind-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t1$res_cor[1:40, ]
kable(df, align = 'c', digits = 4, caption = "Independent of H. pylori status") %>% kable_styling(position = "center") %>%
  add_header_above(c("Oral IL8 spearman" = 8), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r echo=F, fig.cap = "IL8 and Buccal alpha diversity Spearman correlations independent of H. pylori status"}
dataset$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = dataset, group = "Site_status")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# use add_abund_table parameter to add the extra data table
t1$cal_cor(add_abund_table = dataset$alpha_diversity)
p <- t1$plot_corr() +
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
#  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(expression(atop("Buccal Cavity Alpha Diversity", atop(italic("Independent of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/buccal-alpha_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
df <- t1$res_cor[1:20, ]
kable(df, align = 'c', digits = 4, caption = "Independent of H. pylori status") %>% kable_styling(position = "center") %>%
  add_header_above(c("Oral alpha diversity" = 8), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
```

```{r save_object, include=F}
## Save object
dir.create("rdata_objects", showWarnings = FALSE)
save.image(file=file.path("rdata_objects", "hp_analysis.Rdata"))
```

## Record session information

```{r session_info, echo=F}
sessionInfo()
```
