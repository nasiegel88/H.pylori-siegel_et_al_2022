---
title: "H.pylori Rhesus Microbiome Analysis"
author: 
  - "Noah Siegel"
date:  "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs",
  output_format = "all")})
output:
  html_document: default
---

## Data used in analysis
```{r include=F}
source("R/packages.R")
source("R/seasons.R")
# Set up global options for nice reports and keeping figures:
knitr::opts_chunk$set(fig.width=14, fig.height=8, fig.align="center",
                      warning=FALSE, message=FALSE)
# install dependencies
```

```{r include=F}
# generate phyloseq object
metadata<-read.table(file.path(getwd(),"data", "noblank-sample-metadata.txt"), row.names=1, sep='\t', quote="", header=TRUE) # updated metadata for MLD manuscript-1
merge_meta <- metadata %>% unite(Site_status, Treatment, site, remove=F)
pub.metadatapath =normalizePath(path=tempdir(), winslash = "/", mustWork = NA) # fix window path issue

# export cleaned metadata to temporary directory
write.table(merge_meta, file= paste(pub.metadatapath,"-metadata.tsv", sep=""), 
            quote=F, col.names = TRUE, sep='\t')
file= paste(pub.metadatapath,"-metadata.tsv", sep="")

physeq<-qza_to_phyloseq(
    features=file.path(getwd(), "data", "id_filtered-asv-table.qza"),
    tree=file.path(getwd(),"data", "rooted_tree.qza"),
    taxonomy=file.path(getwd(),"data", "filtered_tax_sklearn.qza"),
    metadata = file
    )
physeq <- subset_taxa(physeq, Genus != "NA")
```

```{r include=F}
metadata <-merge_meta
metadata <- metadata %>% rownames_to_column("SampleID")
uwunifrac<-read_qza(file.path(getwd(),"data", "unweighted_unifrac_pcoa_results.qza"))
phytree <- phy_tree(physeq)
```

```{r echo=F}
# oringal physeq
table <- as.data.frame(otu_table(physeq))

kbl(table, booktabs = T, digits = 3, caption = "ASV Count Table") %>% kable_styling(position = "left") %>%
  add_header_above(c("ASV Count Table" = 24), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "200%", height = "600px")

taxa <- as.data.frame(tax_table(physeq))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
kbl(taxa, booktabs = T, digits = 3, caption = "ASV Taxa Table") %>% kable_styling(position = "left") %>%
  add_header_above(c("ASV Taxa Table" = 8), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "200%", height = "600px")

subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
)
row.names(subsetted) <- subsetted[,1]
kable(subsetted, align = 'c', digits = 3, caption = "H.pylori Metadata") %>% kable_styling(position = "center") %>%
  add_header_above(c("H.pylori Metadata" = 9), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%")
subsetted <- subsetted[1:(length(subsetted)-1)]
```

```{r echo=F, fig.cap = "This plot only includes animals that had material sequenced and not all 25 animals from the study"}
no_duplicates <- metadata %>% filter(site=="BAL") # will remove duplicates
p <- ggscatter(no_duplicates,
          y = "IL8_Lavage", 
          x = "log10_cfu.gm",
          add = "reg.line",
          conf.int = TRUE, 
          cor.coef = TRUE,
          repel=T,
          cor.method = "pearson",
          cor.coeff.args = list(method = "pearson", label.x.npc = "left", label.y.npc = "bottom"),
          size=5,
          cor.coef.size = 10,
          xlab = "Gastric H. pylori load (log10CFU/g)",
          ylab = "Lavage IL8 (pg)") +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("H.pylori Il8 Pearson correlation")
p <- ggpar(p , ylim = c(5, 20))
ggsave(plot=p,
       filename="results/BAL_IL8-corr.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "This plot only includes animals that had material sequenced and not all 25 animals from the study"}
no_duplicates <- metadata %>% filter(site=="BAL") # will remove duplicates
p <- ggscatter(no_duplicates,
          y = "IL8_Plasma",
          x = "log10_cfu.gm", 
          add = "reg.line",
          conf.int = TRUE, 
          cor.coef = TRUE,
          cor.method = "pearson",
          size=5,
          cor.coef.size = 10,
          ylab = "Plasma IL8 (pg)", 
          xlab = "Gastric H. pylori load (log10CFU/g)") +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("H.pylori plasma IL8 Pearson correlation")
p <- ggpar(p)
ggsave(plot=p,
       filename="results/Serum_IL8_heparinized-corr.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F}
# original physeq
dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(dataset)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()
```

## ASVs associated with lavage

```{r cache=F, echo=F}
# bal physeq
bp <- subset_samples(physeq, site=="BAL")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="BAL")
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(data)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data$sample_table <- subset(data$sample_table, site == "BAL")
data1 <- data$merge_samples(use_group = "Treatment")
t1 <- trans_venn$new(data1, ratio = "numratio")
p <- t1$plot_venn(color_circle = c("green", "purple"),
             text_name_size = 12,
             text_size = 10)  +
  theme(text = element_text(size=12)) +
  ggtitle("BAL")
ggsave(plot=p,
       filename="results/bal-venn.png",
       width=16,
       height=8,
       dpi=300)
p
```

## ASVs associated with buccal swabs 

```{r cache=F, echo=F}
# swab physeq
bp <- subset_samples(physeq, site=="Swab")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                sex,
                log10_cfu.gm,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="Swab")
row.names(subsetted) <- subsetted[,1]
# original physeq
data <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(data)
data$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
data$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
data$tidy_dataset()
data$cal_abund()
data$sample_table <- subset(data$sample_table, site == "Swab")
data1 <- data$merge_samples(use_group = "Treatment")
t1 <- trans_venn$new(data1, ratio = "numratio")

p <- t1$plot_venn(color_circle = c("orange", "blue"),
             text_name_size = 12,
             text_size = 10)  +
  theme(text = element_text(size=12)) +
  ggtitle("Swab")
ggsave(plot=p,
       filename="results/swab-venn.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Unweighted unifrac PCoA plots

```{r include=F}
data=uwunifrac$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata)
```

```{r echo=F, figures-side, fig.show="hold"}
site = ggplot(data,aes(x=PC1, y=PC2, color=`site`)) +
geom_point(alpha=0.8, size=4) + 
theme_q2r() +
scale_color_manual(name="Site", labels = c("Lavage", "Buccal"), values=c("dark red", "dark blue")) + 
theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Site Unweighted unifrac PCoA")
ggsave(plot=site,
       filename="results/site-unweighted_unifrac.png",
       width=16,
       height=8,
       dpi=300)
site

treatment_site = ggplot(data,aes(x=PC1, y=PC2, color=interaction(Treatment,site))) +
geom_point(alpha=0.8, size=4) + 
theme_q2r() +
scale_color_manual(name="Status",labels = c("H. pylori (-) Lavage", "H. pylori (+) Lavage", "H. pylori (-) Buccal", "H. pylori (+) Buccal"), values=c("green", "purple", "orange", "blue")) + 
theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Status Unweighted unifrac PCoA")
ggsave(plot=treatment_site,
       filename="results/site_treatment-unweighted_unifrac.png",
       width=16,
       height=8,
       dpi=300)
treatment_site
```

```{r echo=F}
data1 <- clone(dataset)
data1$tidy_dataset()
data1$cal_betadiv(unifrac = TRUE)

t1 <- trans_beta$new(dataset = data1, group = "Site_status", measure = "bray", ordination = "PCoA")
t1$cal_group_distance(within_group = T)
p <- t1$plot_group_distance(distance_pair_stat = F) +
  scale_color_manual(name="Site", values=c("green", "orange", "purple", "blue")) +
  geom_boxplot(alpha=0.8, size=1) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Beta diversity")
ggsave(plot=p,
       filename="results/bray-curtis.png",
       width=16,
       height=8,
       dpi=300)
p
```
## Alpha Diversity (Observed ASVs)

```{r echo=F}
p <- plot_richness(physeq, x="Site_status", color="site", measures=c("Observed")) + 
  geom_boxplot(alpha=0.8, size=1) +
  geom_point(alpha=0.8, size=4) +
  facet_wrap(~site + Treatment, scales= "free_x", nrow=1) +
  scale_color_manual(name="Site", labels = c("Lavage", "Buccal"), values=c("dark red", "dark blue")) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Observed ASVs")
ggsave(plot=p,
       filename="results/observed-asvs.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Alpha diversity measures

```{r echo=F}
data1$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = data1, group = "Site_status")
t1$cal_diff(method = "KW")
kable(t1$res_alpha_diff, align = 'c', digits = 3, caption = "All alpha diversity measurees") %>% kable_styling(position = "center") %>%
  add_header_above(c("Apha Diversity Assessement" = 5), font_size = "larger", bold = T, align = "l")  %>% scroll_box(width = "100%",height = "600px")
```

```{r echo=F, out.extra='style="float:left"'}
hp <-  subset_taxa(physeq, Genus == "Helicobacter")

p <- plot_bar(hp, "Treatment", "Abundance","Species", title="Helicobacter ASVs")  +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(cols = vars(site))
ggsave(plot=p,
       filename="results/helicobacter_abundance.png",
       width=16,
       height=8,
       dpi=300)
p
```

## Taxa barplots

```{r echo=F, fig.cap = "Microbiota Composition at Phylum level."}
t1 <- trans_abund$new(dataset = dataset, taxrank = "Phylum", ntaxa = 10)
p <- t1$plot_bar(use_colors=spring,others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Phyla")
ggsave(plot= p,
       filename="results/phylum-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p
```


```{r echo=F, fig.cap = "Microbiota Composition at Class level."}
t1 <- trans_abund$new(dataset = dataset, taxrank = "Class", ntaxa = 10)
p <- t1$plot_bar(use_colors=spring,others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 28) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Class")
ggsave(plot=p,
       filename="results/class-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "Microbiota Composition at Order level."}
t1 <- trans_abund$new(dataset = dataset, taxrank = "Order", ntaxa = 10)
p <- t1$plot_bar(use_colors=spring, others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Order")
ggsave(plot=treatment_site,
       filename="results/order-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "Microbiota Composition at Family level."}
t1 <- trans_abund$new(dataset = dataset, taxrank = "Family", ntaxa = 10)
p <- t1$plot_bar(use_colors=spring, others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Family")
ggsave(plot=p,
       filename="results/family-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "Microbiota Composition at Genus level."}
t1 <- trans_abund$new(dataset = dataset, taxrank = "Genus", ntaxa = 10)
p <- t1$plot_bar(use_colors=spring,others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Genus")
ggsave(plot=p,
       filename="results/genus-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p
```
```{r echo=F, fig.cap = "Microbiota Composition at Species level. The most abundance sequences at the species level were unidentified taxa. This does not mean there was no species level detection."}
t1 <- trans_abund$new(dataset = dataset, taxrank = "Species", ntaxa = 10)
p <- t1$plot_bar(others_color = "grey70", facet = c("Treatment","site"), xtext_keep = FALSE, legend_text_italic = FALSE) +
  theme_classic(base_size = 22) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Species")
ggsave(plot=p,
       filename="results/phylum-taxabarplots.png",
       width=16,
       height=8,
       dpi=300)
p
```


## DeSeq2 differential abundance between BAL and Swabs

#### Phylum level differential abundance

```{r echo=F}
sample_data(physeq)$site <- as.factor(sample_data(physeq)$site) # factorize for DESeq2
ps.taxa <- tax_glom(physeq, taxrank = 'Phylum', NArm = FALSE)
ps.taxa.pse <- ps.taxa
otu_table(ps.taxa.pse) <- otu_table(ps.taxa) + 1
ps.taxa.pse.sub <- subset_samples(ps.taxa.pse, site %in% c("BAL", "Swab"))
ds = phyloseq_to_deseq2(ps.taxa.pse.sub, ~ site)
ds = DESeq(ds, test="Wald", fitType="parametric")
alpha = 0.05 
res = results(ds, alpha=alpha)
res = res[order(res$padj, na.last=NA), ]
taxa_sig = rownames(res[1:10, ]) # select bottom 20 with lowest p.adj values
ps.taxa.rel <- transform_sample_counts(physeq, function(x) x/sum(x)*100)
ps.taxa.rel.sig <- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples
ps.taxa.rel.sig <- prune_samples(colnames(otu_table(ps.taxa.pse.sub)), ps.taxa.rel.sig)
```

```{r echo=F}
matrix <- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))

remove <- as.factor(c("d98cfee4a9aa6242af0c509639f42f81"))

matrix = matrix[!row.names(matrix)%in%remove,]

rownames(matrix) <- as.character(tax_table(ps.taxa.rel.sig)[, "Phylum"]%>% na.exclude)

metadata_sub <- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Treatment = as.factor(metadata_sub$Treatment), 
    `Site` = as.factor(metadata_sub$site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps.taxa.rel.sig)[, "Phylum"]%>% na.exclude)
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), "Paired")
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Treatment = c(`H.pylori_(+)` = "red", `H.pylori_(-)` = "blue"),
    `Site` = c(BAL = "purple", Swab = "yellow"),
    Phylum = phylum_col
)

svg("results/phylum-DEG_heatmap.svg", width=20, height=12)
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Phylum Differential Taxa (DESeq2)",
                         fontsize = 20)
dev.off()
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Phylum Differential Taxa (DESeq2)",
                         fontsize = 20)
```

#### Class level differential abundance

```{r echo=F}
sample_data(physeq)$site <- as.factor(sample_data(physeq)$site) # factorize for DESeq2
ps.taxa <- tax_glom(physeq, taxrank = 'Class', NArm = FALSE)
ps.taxa.pse <- ps.taxa
otu_table(ps.taxa.pse) <- otu_table(ps.taxa) + 1
ps.taxa.pse.sub <- subset_samples(ps.taxa.pse, site %in% c("BAL", "Swab"))
ds = phyloseq_to_deseq2(ps.taxa.pse.sub, ~ site)
ds = DESeq(ds, test="Wald", fitType="parametric")
alpha = 0.05 
res = results(ds, alpha=alpha)
res = res[order(res$padj, na.last=NA), ]
taxa_sig = rownames(res[1:20, ]) # select bottom 20 with lowest p.adj values
ps.taxa.rel <- transform_sample_counts(physeq, function(x) x/sum(x)*100)
ps.taxa.rel.sig <- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples
ps.taxa.rel.sig <- prune_samples(colnames(otu_table(ps.taxa.pse.sub)), ps.taxa.rel.sig)
```

```{r echo=F}
matrix <- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))

remove <- as.factor(c("d98cfee4a9aa6242af0c509639f42f81"))

matrix = matrix[!row.names(matrix)%in%remove,]

rownames(matrix) <- as.character(tax_table(ps.taxa.rel.sig)[, "Class"]%>% na.exclude)

metadata_sub <- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Treatment = as.factor(metadata_sub$Treatment), 
    `Site` = as.factor(metadata_sub$site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Order = as.factor(tax_table(ps.taxa.rel.sig)[, "Class"]%>% na.exclude)
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), "Paired")
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Treatment = c(`H.pylori_(+)` = "red", `H.pylori_(-)` = "blue"),
    `Site` = c(BAL = "purple", Swab = "yellow"),
    Phylum = phylum_col
)

svg("results/class-DEG_heatmap.svg", width=20, height=12)
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Class Differential Taxa (DESeq2)",
                         fontsize = 16)
dev.off()
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Class Differential Taxa (DESeq2)",
                         fontsize = 16)

```

#### Order level differential abundance

```{r echo=F}
sample_data(physeq)$site <- as.factor(sample_data(physeq)$site) # factorize for DESeq2
ps.taxa <- tax_glom(physeq, taxrank = 'Order', NArm = FALSE)
ps.taxa.pse <- ps.taxa
otu_table(ps.taxa.pse) <- otu_table(ps.taxa) + 1
ps.taxa.pse.sub <- subset_samples(ps.taxa.pse, site %in% c("BAL", "Swab"))
ds = phyloseq_to_deseq2(ps.taxa.pse.sub, ~ site)
ds = DESeq(ds, test="Wald", fitType="parametric")
alpha = 0.05 
res = results(ds, alpha=alpha)
res = res[order(res$padj, na.last=NA), ]
taxa_sig = rownames(res[1:10, ]) # select bottom 20 with lowest p.adj values
ps.taxa.rel <- transform_sample_counts(physeq, function(x) x/sum(x)*100)
ps.taxa.rel.sig <- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples
ps.taxa.rel.sig <- prune_samples(colnames(otu_table(ps.taxa.pse.sub)), ps.taxa.rel.sig)
```

```{r echo=F}
matrix <- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))

remove <- as.factor(c("c465f577ff4ace3e12a8479197bd7198","56c853249a8f9e5238ac5101b0edc245"))

matrix = matrix[!row.names(matrix)%in%remove,]

rownames(matrix) <- as.character(tax_table(ps.taxa.rel.sig)[, "Order"]%>% na.exclude)

metadata_sub <- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Treatment = as.factor(metadata_sub$Treatment), 
    `Site` = as.factor(metadata_sub$site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Order = as.factor(tax_table(ps.taxa.rel.sig)[, "Order"]%>% na.exclude)
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), "Paired")
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Treatment = c(`H.pylori_(+)` = "red", `H.pylori_(-)` = "blue"),
    `Site` = c(BAL = "purple", Swab = "yellow"),
    Phylum = phylum_col
)

svg("results/order-DEG_heatmap.svg", width=20, height=12)
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Order Differential Taxa (DESeq2)",
                         fontsize = 20)
dev.off()
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Order Differential Taxa (DESeq2)",
                         fontsize = 20)
```

#### Family level differential abundance

```{r echo=F}
sample_data(physeq)$site <- as.factor(sample_data(physeq)$site) # factorize for DESeq2
ps.taxa <- tax_glom(physeq, taxrank = 'Family', NArm = FALSE)
ps.taxa.pse <- ps.taxa
otu_table(ps.taxa.pse) <- otu_table(ps.taxa) + 1
ps.taxa.pse.sub <- subset_samples(ps.taxa.pse, site %in% c("BAL", "Swab"))
ds = phyloseq_to_deseq2(ps.taxa.pse.sub, ~ site)
ds = DESeq(ds, test="Wald", fitType="parametric")
alpha = 0.05 
res = results(ds, alpha=alpha)
res = res[order(res$padj, na.last=NA), ]
taxa_sig = rownames(res[1:20, ]) # select bottom 20 with lowest p.adj values
ps.taxa.rel <- transform_sample_counts(physeq, function(x) x/sum(x)*100)
ps.taxa.rel.sig <- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples
ps.taxa.rel.sig <- prune_samples(colnames(otu_table(ps.taxa.pse.sub)), ps.taxa.rel.sig)
```

```{r echo=F}
matrix <- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))

remove <- as.factor(c("c465f577ff4ace3e12a8479197bd7198","56c853249a8f9e5238ac5101b0edc245"))

matrix = matrix[!row.names(matrix)%in%remove,]

rownames(matrix) <- as.character(tax_table(ps.taxa.rel.sig)[, "Family"]%>% na.exclude)

metadata_sub <- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Treatment = as.factor(metadata_sub$Treatment), 
    `Site` = as.factor(metadata_sub$site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Family = as.factor(tax_table(ps.taxa.rel.sig)[, "Family"]%>% na.exclude)
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), "Paired")
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Treatment = c(`H.pylori_(+)` = "red", `H.pylori_(-)` = "blue"),
    `Site` = c(BAL = "purple", Swab = "yellow"),
    Phylum = phylum_col
)

svg("results/family-DEG_heatmap.svg", width=20, height=12)
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Family Differential Taxa (DESeq2)",
                         fontsize = 16)
dev.off()
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Family Differential Taxa (DESeq2)",
                         fontsize = 16)
```

#### Genus level differential abundance

```{r echo=F}
sample_data(physeq)$site <- as.factor(sample_data(physeq)$site) # factorize for DESeq2
ps.taxa <- tax_glom(physeq, taxrank = 'Genus', NArm = FALSE)
ps.taxa.pse <- ps.taxa
otu_table(ps.taxa.pse) <- otu_table(ps.taxa) + 1
ps.taxa.pse.sub <- subset_samples(ps.taxa.pse, site %in% c("BAL", "Swab"))
ds = phyloseq_to_deseq2(ps.taxa.pse.sub, ~ site)
ds = DESeq(ds, test="Wald", fitType="parametric")
alpha = 0.05 
res = results(ds, alpha=alpha)
res = res[order(res$padj, na.last=NA), ]
taxa_sig = rownames(res[1:20, ]) # select bottom 20 with lowest p.adj values
ps.taxa.rel <- transform_sample_counts(physeq, function(x) x/sum(x)*100)
ps.taxa.rel.sig <- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples
ps.taxa.rel.sig <- prune_samples(colnames(otu_table(ps.taxa.pse.sub)), ps.taxa.rel.sig)
```

```{r echo=F}
matrix <- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))

remove <- as.factor(c("c465f577ff4ace3e12a8479197bd7198","56c853249a8f9e5238ac5101b0edc245"))

matrix = matrix[!row.names(matrix)%in%remove,]

rownames(matrix) <- as.character(tax_table(ps.taxa.rel.sig)[, "Genus"]%>% na.exclude)

metadata_sub <- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Treatment = as.factor(metadata_sub$Treatment), 
    `Site` = as.factor(metadata_sub$site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Genus = as.factor(tax_table(ps.taxa.rel.sig)[, "Genus"]%>% na.exclude)
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), "Paired")
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Treatment = c(`H.pylori_(+)` = "red", `H.pylori_(-)` = "blue"),
    `Site` = c(BAL = "purple", Swab = "yellow"),
    Phylum = phylum_col
)

svg("results/genus-DEG_heatmap.svg", width=20, height=12)
ComplexHeatmap::pheatmap(matrix, scale= "row", name="Genus",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Genus Differential Taxa (DESeq2)",
                         fontsize = 18)
dev.off()
ComplexHeatmap::pheatmap(matrix, scale= "row", name="Genus",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Genus Differential Taxa (DESeq2)",
                         fontsize = 18)
```

#### Species level differential abundance

```{r echo=F}
sample_data(physeq)$site <- as.factor(sample_data(physeq)$site) # factorize for DESeq2
ps.taxa <- tax_glom(physeq, taxrank = 'Species', NArm = FALSE)
ps.taxa.pse <- ps.taxa
otu_table(ps.taxa.pse) <- otu_table(ps.taxa) + 1
ps.taxa.pse.sub <- subset_samples(ps.taxa.pse, site %in% c("BAL", "Swab"))
ds = phyloseq_to_deseq2(ps.taxa.pse.sub, ~ site)
ds = DESeq(ds, test="Wald", fitType="parametric")
alpha = 0.05 
res = results(ds, alpha=alpha)
res = res[order(res$padj, na.last=NA), ]
taxa_sig = rownames(res[1:20, ]) # select bottom 20 with lowest p.adj values
ps.taxa.rel <- transform_sample_counts(physeq, function(x) x/sum(x)*100)
ps.taxa.rel.sig <- prune_taxa(taxa_sig, ps.taxa.rel)
# Only keep gut and tongue samples
ps.taxa.rel.sig <- prune_samples(colnames(otu_table(ps.taxa.pse.sub)), ps.taxa.rel.sig)
```

```{r echo=F}
ps.taxa.rel.sig = subset_taxa(ps.taxa.rel.sig, Species != "uncultured_bacterium")
matrix <- as.matrix(data.frame(otu_table(ps.taxa.rel.sig)))

remove <- as.factor(c(
  
"3ec7d55d640b59d6f412ae93441f6d16",
"c465f577ff4ace3e12a8479197bd7198",
"7a6f7f09204ae801cd0200f821858d82",
"caa2d6a2760671284badf6b987c392da",
"463b2f0461c807f6f6a2ebd7bcff9c7a",
"3437ea5ad5d0b98274e368e0083b45ab",
"4f19b1f01413c2c9402ad8afcc0fb165",
"ca7aa200c01082de6dba0813d05b5d9f",
"00b629e3b3acc8ca9d9839c41326c6e7",
"25bd029405b99dc1b53f9799b1247a9c",
"uncultured_bacterium"

))

matrix = matrix[!row.names(matrix)%in%remove,]

rownames(matrix) <- as.character(tax_table(ps.taxa.rel.sig)[, "Species"]%>% na.exclude)

metadata_sub <- data.frame(sample_data(ps.taxa.rel.sig))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Treatment = as.factor(metadata_sub$Treatment), 
    `Site` = as.factor(metadata_sub$site), 
    check.names = FALSE
)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Species = as.factor(tax_table(ps.taxa.rel.sig)[, "Species"]%>% na.exclude)
)
rownames(annotation_row) = rownames(matrix)

# ann_color should be named vectors
phylum_col = RColorBrewer::brewer.pal(length(levels(annotation_row$Phylum)), "Paired")
names(phylum_col) = levels(annotation_row$Phylum)
ann_colors = list(
    Treatment = c(`H.pylori_(+)` = "red", `H.pylori_(-)` = "blue"),
    `Site` = c(BAL = "purple", Swab = "yellow"),
    Phylum = phylum_col
)

svg("results/species-DEG_heatmap.svg", width=20, height=12)
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Species Differential Taxa (DESeq2)",
                         fontsize = 14)
dev.off()
ComplexHeatmap::pheatmap(matrix, scale= "row",
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors,
                         main="Species Differential Taxa (DESeq2)",
                         fontsize = 14)
```


## Compostion correlation with Il8 (Serum and BAL)

```{r echo=F, cache=F, fig.cap = "IL8 and lavage genus abundance Spearman correlations separated by H. pylori status"}
#BAL
bp <- subset_samples(physeq, site=="BAL")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                log10_cfu.gm,
                sex,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="BAL")
row.names(subsetted) <- subsetted[,1]
# original physeq
dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(dataset)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()

# first create trans_diff object
t2 <- trans_diff$new(dataset = dataset, method = "rf", group = "Treatment", rf_taxa_level = "Genus")
# then create trans_env object
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# calculate correlation
t1$cal_cor(use_data = "other",
           p_adjust_method = "fdr",
           cor_method="spearman",
           by_group="Treatment",
           other_taxa = t2$res_rf$Taxa[1:20])
p <- t1$plot_corr()+
  theme_classic(base_size = 20) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
   ggtitle(expression(atop("Lavage Genus Abundance", atop(italic("Grouped by H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/lavage-abundance_sep-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "IL8 and lavage genus abundance Spearman correlations independent of H. pylori status"}
# calculate correlations for different groups using parameter by_group
t1$cal_cor(by_group = "site", use_data = "other", p_adjust_method = "fdr", other_taxa = t2$res_rf$Taxa[1:20])
# return t1$res_cor
p <- t1$plot_corr()+
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(expression(atop("Lavage Genus Abundance", atop(italic("Independent of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/lavage-abundance_ind-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "IL8 and lavage alpha diversity Spearman correlations inpendent of H. pylori status"}
dataset$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = dataset, group = "Site_status")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# use add_abund_table parameter to add the extra data table
t1$cal_cor(add_abund_table = dataset$alpha_diversity)
p <- t1$plot_corr() +
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(expression(atop("Lavage Alpha Diversity", atop(italic("Independnet of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/lavage-alpha_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, cache=F, fig.cap = "IL8 and Buccal genus abundance Spearman correlations separated by H. pylori status"}
#Swab
bp <- subset_samples(physeq, site=="Swab")
table <- as.data.frame(otu_table(bp))
taxa <- as.data.frame(tax_table(bp))
taxa$Kingdom  <- str_replace(taxa$Kingdom, "d__" , "k__")
taxa$Phylum   <- str_c("p_", taxa$Phylum  , sep="_")
taxa$Class    <- str_c("c_", taxa$Class   , sep="_")
taxa$Order    <- str_c("o_", taxa$Order   , sep="_")
taxa$Family   <- str_c("f_", taxa$Family  , sep="_")
taxa$Genus    <- str_c("g_", taxa$Genus   , sep="_")
taxa$Species  <- str_c("s_", taxa$Species, sep="_") 
subsetted <- metadata %>% select(SampleID,
                Treatment,
                site,
                Site_status,
                log10_cfu.gm,
                sex,
                IL8_Lavage,
                IL8_Plasma
) %>% filter(site=="Swab")
row.names(subsetted) <- subsetted[,1]
# original physeq
dataset <- microtable$new(sample_table = subsetted,
                          otu_table = table,
                          tax_table = taxa,
                          phylo_tree = phytree)
class(dataset)
dataset$tax_table %<>% base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
dataset$filter_pollution(taxa = c("mitochondria", "chloroplast", "uncultured", "unidentified"))
dataset$tidy_dataset()
dataset$cal_abund()

# first create trans_diff object
t2 <- trans_diff$new(dataset = dataset, method = "rf", group = "Treatment", rf_taxa_level = "Genus")
# then create trans_env object
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# calculate correlation
p <- t1$cal_cor(use_data = "other",
           p_adjust_method = "fdr",
           cor_method="spearman",
           by_group="Treatment",
           other_taxa = t2$res_rf$Taxa[1:20])
p <- t1$plot_corr()+
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(expression(atop("Buccal Cavity Genus Abundance", atop(italic("Grouped by H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/buccal-abundance_sep-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "IL8 and  Buccal genus abundance Spearman correlations independent of H. pylori status"}
# calculate correlations for different groups using parameter by_group
t1$cal_cor(by_group = "site", use_data = "other", p_adjust_method = "fdr", other_taxa = t2$res_rf$Taxa[1:20])
# return t1$res_cor
p <- t1$plot_corr()+
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(expression(atop("Buccal Cavity Genus Abundance", atop(italic("Independent of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/buccal-abundance_ind-hp_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r echo=F, fig.cap = "IL8 and Buccal alpha diversity Spearman correlations independent of H. pylori status"}
dataset$cal_alphadiv(PD = TRUE)
t1 <- trans_alpha$new(dataset = dataset, group = "Site_status")
t1 <- trans_env$new(dataset = dataset, add_data = subsetted[, 7:8])
# use add_abund_table parameter to add the extra data table
t1$cal_cor(add_abund_table = dataset$alpha_diversity)
p <- t1$plot_corr() +
  theme_classic(base_size = 20)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle(expression(atop("Buccal Cavity Alpha Diversity", atop(italic("Independnet of H. pylori status"), ""))))
ggsave(plot=p,
       filename="results/buccal-alpha_il8-spearman.png",
       width=16,
       height=8,
       dpi=300)
p
```

```{r save_object, include=F}
## Save object
dir.create("rdata_objects", showWarnings = FALSE)
save.image(file=file.path("rdata_objects", "hp_analysis.Rdata"))
```

## Record session information

```{r session_info, echo=F}
sessionInfo()
```


